{
  "version": "2.0.0",
  "$schema": "vscode://schemas/tasks",
  "tasks": [
    {
      "label": "EvalForge: Dev Server (Judge/Coach/Greeter + MCP)",
      "type": "shell",
      "command": "python",
      "args": [
        "-m",
        "uvicorn",
        "arcade_app.agent:app",
        "--host",
        "127.0.0.1",
        "--port",
        "19000",
        "--reload"
      ],
      "options": {
        "cwd": "${workspaceFolder}",
        "env": {
          "EVALFORGE_ENV": "dev",
          "EVALFORGE_PROJECT_ID": "291179078777",
          "EVALFORGE_MODEL": "gemini-2.5-flash",
          "EVALFORGE_REGION": "us-central1",
          "EVALFORGE_ENABLE_GREETER": "1",
          "EVALFORGE_ENABLE_JUDGE": "1",
          "EVALFORGE_ENABLE_COACH": "1",
          "EVALFORGE_DEV_INTROSPECTION": "1",
          "EVALFORGE_ENABLE_MCP": "1",
          "EVALFORGE_EVENT_LOG": "1",
          "GOOGLE_GENAI_USE_VERTEXAI": "TRUE",
          "GOOGLE_CLOUD_PROJECT": "291179078777",
          "GOOGLE_CLOUD_LOCATION": "us-central1",
          "GOOGLE_CLOUD_AGENT_ENGINE_ID": "7681298182805913600"
        }
      },
      "isBackground": true,
      "problemMatcher": [],
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "focus": false,
        "clear": false,
        "group": "SERVER"
      }
    },
    {
      // ── Background server (LOCAL) - Legacy ────────────────────────────────────
      "label": "serve:local",
      "type": "shell",
      "command": "$env:VERTEX_PROJECT_NUMBER='291179078777'; $env:VERTEX_REGION='us-central1'; $env:VERTEX_MODEL_ID='gemini-2.5-flash'; New-Item -ItemType Directory -Force -Path logs | Out-Null; D:/EvalForge/.venv/Scripts/python.exe -m google.adk.cli web arcade_app --port 19000 --host 0.0.0.0 2>&1 | Tee-Object -FilePath logs/server.local.log",
      "options": { 
        "cwd": "${workspaceFolder}",
        "shell": {
          "executable": "pwsh.exe",
          "args": ["-Command"]
        }
      },
      "isBackground": true,
      "problemMatcher": {
        "pattern": {
          "regexp": "^$"
        },
        "background": {
          "activeOnStart": true,
          "beginsPattern": ".*(starting|Running on|\\[startup\\]).*",
          "endsPattern": ".*(Uvicorn running on|Application startup complete|\\[startup\\] vertexai\\.init\\(\\) called).*"
        }
      },
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "group": "SERVER"
      },
      "runOptions": { 
        "reevaluateOnRerun": true 
      }
    },

    {
      // ── Cloud smoke (PROD) ───────────────────────────────────────────────────
      "label": "smoke:cloud",
      "type": "shell",
      "command": "${workspaceFolder}/scripts/smoke.ps1",
      "options": { 
        "cwd": "${workspaceFolder}",
        "shell": {
          "executable": "pwsh.exe",
          "args": ["-File"]
        }
      },
      "problemMatcher": [],
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "group": "CHECKS",
        "clear": true
      }
    },

    {
      // ── Local smoke (DEV) ────────────────────────────────────────────────────
      "label": "smoke:local",
      "type": "shell",
      "command": "New-Item -ItemType Directory -Force -Path logs | Out-Null; Write-Host '→ discovery' -ForegroundColor Cyan; curl.exe -sf 'http://127.0.0.1:19000/list-apps?relative_path=arcade_app' | Out-Null; if ($?) { Write-Host '✓ discovery passed' -ForegroundColor Green } else { Write-Host '✗ discovery failed' -ForegroundColor Red; exit 1 }; Write-Host '→ session' -ForegroundColor Cyan; curl.exe -sf -X POST -H 'Content-Length: 0' 'http://127.0.0.1:19000/apps/arcade_app/users/user/sessions' | Out-Null; if ($?) { Write-Host '✓ session passed' -ForegroundColor Green } else { Write-Host '✗ session failed' -ForegroundColor Red; exit 1 }; Write-Host '✓ local smoke passed' -ForegroundColor Green | Tee-Object -FilePath logs/smoke.local.log",
      "options": { 
        "cwd": "${workspaceFolder}",
        "shell": {
          "executable": "pwsh.exe",
          "args": ["-Command"]
        }
      },
      "problemMatcher": [],
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "group": "CHECKS",
        "clear": true
      }
    },

    {
      // ── Guardrail test ───────────────────────────────────────────────────────
      "label": "test:guardrail",
      "type": "shell",
      "command": "D:/EvalForge/.venv/Scripts/python.exe tests/test_env_model.py 2>&1 | Tee-Object -FilePath logs/test.guardrail.log",
      "options": { 
        "cwd": "${workspaceFolder}",
        "shell": {
          "executable": "pwsh.exe",
          "args": ["-Command"]
        }
      },
      "problemMatcher": [],
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "group": "CHECKS",
        "clear": true
      }
    },

    {
      // ── Deploy to Cloud Run ──────────────────────────────────────────────────
      "label": "deploy:cloud",
      "type": "shell",
      "command": "${workspaceFolder}/manual_deploy.ps1",
      "options": { 
        "cwd": "${workspaceFolder}",
        "shell": {
          "executable": "pwsh.exe",
          "args": ["-File"]
        }
      },
      "problemMatcher": [],
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "group": "DEPLOY",
        "clear": false
      }
    },

    {
      // ── Fast rollback ────────────────────────────────────────────────────────
      "label": "rollback:fast",
      "type": "shell",
      "command": "${workspaceFolder}/fast_rollback.ps1",
      "options": { 
        "cwd": "${workspaceFolder}",
        "shell": {
          "executable": "pwsh.exe",
          "args": ["-File"]
        }
      },
      "problemMatcher": [],
      "presentation": {
        "reveal": "always",
        "panel": "dedicated",
        "group": "DEPLOY",
        "clear": false
      }
    },

    {
      // ── One-shot: run both smokes after server is ready ─────────────────────
      "label": "smoke:all",
      "dependsOrder": "sequence",
      "dependsOn": ["serve:local", "smoke:local", "smoke:cloud"],
      "problemMatcher": []
    },

    // ── Legacy tasks (preserved) ─────────────────────────────────────────────
    {
      "label": "Run: Vitest (logged)",
      "type": "shell",
      "command": "pwsh -File scripts/log_wrap.ps1",
      "windows": { "command": "pwsh -File scripts/log_wrap.ps1" },
      "linux":   { "command": "bash scripts/log_wrap.sh" },
      "osx":     { "command": "bash scripts/log_wrap.sh" },
      "args": [
        "--tag", "vitest",
        "--cmd", "scripts/run_vitest.sh debounce",
        "--art", "exercises/js/coverage/coverage-final.json"
      ],
      "problemMatcher": [],
      "presentation": {
        "echo": true,
        "reveal": "always",
        "focus": false,
        "panel": "shared"
      }
    },
    {
      "label": "Run: ADK web (logged)",
      "type": "shell",
      "command": "pwsh -File scripts/log_wrap.ps1",
      "windows": { "command": "pwsh -File scripts/log_wrap.ps1" },
      "linux":   { "command": "bash scripts/log_wrap.sh" },
      "osx":     { "command": "bash scripts/log_wrap.sh" },
      "args": ["--tag","adk","--cmd","adk web arcade_app --port 19000"],
      "isBackground": true,
      "problemMatcher": []
    },
    {
      "label": "Run: Pytest (logged)",
      "type": "shell",
      "command": "pwsh -File scripts/log_wrap.ps1",
      "windows": { "command": "pwsh -File scripts/log_wrap.ps1" },
      "linux":   { "command": "bash scripts/log_wrap.sh" },
      "osx":     { "command": "bash scripts/log_wrap.sh" },
      "args": ["--tag","pytest","--cmd","scripts/run_pytest.sh"],
      "problemMatcher": []
    },
    {
      "label": "Run: Judge Agent Test (logged)",
      "type": "shell",
      "command": "pwsh -File scripts/log_wrap.ps1",
      "windows": { "command": "pwsh -File scripts/log_wrap.ps1" },
      "linux":   { "command": "bash scripts/log_wrap.sh" },
      "osx":     { "command": "bash scripts/log_wrap.sh" },
      "args": [
        "--tag", "judge-test",
        "--cmd", "python -c \"from arcade_app.agent import run_tests, grade_submission; result = run_tests('pwsh -File scripts/run_vitest.ps1 debounce', ['exercises/js/coverage/coverage-final.json']); print('Verdict:', grade_submission(result, {}))\"",
        "--art", "exercises/js/coverage/coverage-final.json"
      ],
      "problemMatcher": []
    },
    {
      "label": "Analyze Error Patterns",
      "type": "shell",
      "command": "python",
      "args": ["tools/aggregate_errors.py"],
      "problemMatcher": []
    },

    // ── New: Drop-in server and health check tasks ───────────────────────────
    {
      "label": "adk:dev",
      "type": "shell",
      "command": "$env:VERTEX_PROJECT_NUMBER='291179078777'; $env:VERTEX_REGION='us-central1'; $env:VERTEX_MODEL_ID='gemini-2.5-flash'; D:/EvalForge/.venv/Scripts/python.exe -m google.adk.cli web . --host 0.0.0.0 --port 19000",
      "options": {
        "cwd": "${workspaceFolder}",
        "shell": {
          "executable": "pwsh.exe",
          "args": ["-NoExit", "-Command"]
        }
      },
      "presentation": { "reveal": "always", "panel": "dedicated", "group": "server" },
      "problemMatcher": []
    },
    {
      "label": "health:local",
      "type": "shell",
      "command": "powershell",
      "args": [
        "-Command",
        "curl -sf \"http://127.0.0.1:19000/list-apps?relative_path=arcade_app\" | Out-Null; Write-Host '✓ discovery (local)' -ForegroundColor Green; $r=Invoke-WebRequest -Uri 'http://127.0.0.1:19000/apps/arcade_app/users/user/sessions' -Method POST -UseBasicParsing; Write-Host ('✓ session (local) - Status: {0}' -f $r.StatusCode) -ForegroundColor Green"
      ],
      "presentation": { "reveal": "always", "panel": "new", "group": "checks" },
      "dependsOn": [],
      "problemMatcher": []
    },
    {
      "label": "health:prod",
      "type": "shell",
      "command": "powershell",
      "args": [
        "-Command",
        "curl -sf \"https://evalforge-agents-uc7hnhrrkq-uc.a.run.app/list-apps?relative_path=arcade_app\" | Out-Null; Write-Host '✓ discovery (prod)' -ForegroundColor Green; $r=Invoke-WebRequest -Uri 'https://evalforge-agents-uc7hnhrrkq-uc.a.run.app/apps/arcade_app/users/user/sessions' -Method POST -UseBasicParsing; Write-Host ('✓ session (prod) - Status: {0}' -f $r.StatusCode) -ForegroundColor Green"
      ],
      "presentation": { "reveal": "always", "panel": "new", "group": "checks" },
      "problemMatcher": []
    },
    {
      "label": "logs:cloudrun",
      "type": "shell",
      "command": "gcloud",
      "args": [
        "logging", "read",
        "resource.type=cloud_run_revision AND resource.labels.service_name=evalforge-agents",
        "--limit=20",
        "--format=table(timestamp,textPayload)",
        "--freshness=10m",
        "--order=desc"
      ],
      "presentation": { "reveal": "always", "panel": "new", "group": "checks" },
      "problemMatcher": []
    }
  ]
}
