============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0 -- C:\Python313\python.exe
cachedir: .pytest_cache
rootdir: D:\EvalForge
plugins: anyio-4.11.0, Faker-37.11.0, langsmith-0.4.38, asyncio-1.2.0, cov-7.0.0, env-1.2.0, httpx-0.35.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 2 items

tests/backend/test_senior_tier_visibility.py::test_senior_progress_api FAILED [ 50%]
tests/backend/test_senior_tier_visibility.py::test_senior_boss_runs_api FAILED [100%]

================================== FAILURES ===================================
__________________________ test_senior_progress_api ___________________________

client = <httpx.AsyncClient object at 0x0000028785C0F380>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x0000028785CE63C0>
test_user = User(id='test_senior_user', name='Senior Tester', avatar_url=None, current_avatar_id='default_user', created_at=datetime.datetime(2025, 12, 8, 16, 34, 10, 605135))
mock_auth = None

    async def test_senior_progress_api(client: AsyncClient, db_session, test_user: User, mock_auth):
        """
        Verify /api/profile/senior_progress returns correct aggregation.
        """
        # 1. Setup Data
        # Ensure profile exists (created by fixture usually, but verify)
        profile = (await db_session.exec(select(Profile).where(Profile.user_id == test_user.id))).first()
        if not profile:
            profile = Profile(user_id=test_user.id, username="test_senior")
            db_session.add(profile)
            await db_session.commit()
    
        # Create a senior boss run (Win)
        # Pick a real senior boss ID if possible, or mock one if the system allows arbitrary IDs.
        # The constants validation might be strict.
        # Let's use a known one: "boss-foundry-systems-architect" (Python Senior)
        senior_boss_id = "boss-foundry-systems-architect"
    
        # We might need to seed the BossDefinition first if foreign keys are enforced and not seeded in test DB.
        # Check if we need to seed definitions.
        # Usually tests run against a DB that might be empty.
        # Let's seed a mock definition just in case.
        boss_def = BossDefinition(
            id=senior_boss_id,
            name="Mock Senior Boss",
            track_id="foundry-senior-systems",
            world_id="world-python",
            difficulty="legendary"
        )
        db_session.add(boss_def)
    
        # Add a run
        run = BossRun(
            user_id=test_user.id,
            boss_id=senior_boss_id,
            result="win",
            score=100,
            hp_remaining=0, # This might mean 0 remaining HP for boss? Or for user?
            # Usually for boss runs, `hp_remaining` is boss HP? Or player integrity?
            # The frontend logic `integrity = hp_remaining` suggests it's player health?
            # Let's set it to 1.0 (100%) just in case context implies integrity.
            # Actually API logic: `integrity=float(getattr(run, "hp_remaining", 0.0) or 0.0)`
            completed_at=datetime.utcnow()
        )
        db_session.add(run)
        await db_session.commit()
    
        # Verify DB has item
        check = (await db_session.exec(select(BossRun).where(BossRun.user_id == test_user.id))).all()
        print(f"DEBUG: Test Setup BossRuns: {len(check)}")
    
        # 2. Call API
        resp = await client.get("/api/profile/senior_progress")
        assert resp.status_code == 200, f"Failed: {resp.text}"
    
        data = resp.json()
    
        # 3. Assertions
        # Global counts
        # We added 1 senior boss run.
        # `senior_bosses_cleared` should be at least 1 (if valid senior boss id).
        # Since we used a real ID from constants?
        # Wait, `SENIOR_BOSS_IDS` is imported in service. If "boss-foundry-systems-architect" is in it (it should be).
    
>       assert data["senior_bosses_cleared"] >= 1
E       assert 0 >= 1

tests\backend\test_senior_tier_visibility.py:108: AssertionError
---------------------------- Captured stdout call -----------------------------
DEBUG: Test Setup BossRuns: 1
DEBUG: Using overridden session
DEBUG: Auth User ID: leo
__________________________ test_senior_boss_runs_api __________________________

client = <httpx.AsyncClient object at 0x0000028785D3DF90>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x0000028785CE6120>
test_user = User(id='test_senior_user', name='Senior Tester', avatar_url=None, current_avatar_id='default_user', created_at=datetime.datetime(2025, 12, 8, 16, 34, 11, 351096))
mock_auth = None

    async def test_senior_boss_runs_api(client: AsyncClient, db_session, test_user: User, mock_auth):
        """
        Verify /api/boss_runs/senior returns the history.
        """
        # 1. Setup Data
        senior_boss_id = "boss-synapse-mlops-sentinel" # ML Senior
    
        boss_def = BossDefinition(
            id=senior_boss_id,
            name="ML Sentinel",
            track_id="synapse-senior-mlops",
            world_id="world-ml",
            difficulty="legendary"
        )
        db_session.add(boss_def)
    
        run = BossRun(
            user_id=test_user.id,
            boss_id=senior_boss_id,
            result="win",
            score=8,
            hp_remaining=90, # 90% integrity
            completed_at=datetime.utcnow()
        )
        db_session.add(run)
        await db_session.commit()
    
        # 2. Call API
        resp = await client.get("/api/boss_runs/senior")
        assert resp.status_code == 200
    
        data = resp.json()
        items = data["items"]
    
>       assert len(items) >= 1
E       assert 0 >= 1
E        +  where 0 = len([])

tests\backend\test_senior_tier_visibility.py:151: AssertionError
---------------------------- Captured stdout call -----------------------------
DEBUG: Using overridden session
============================== warnings summary ===============================
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

arcade_app\agent.py:449
  D:\EvalForge\arcade_app\agent.py:449: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\applications.py:4523
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\applications.py:4523: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

tests/backend/test_senior_tier_visibility.py: 10 warnings
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\fields.py:656: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return fac()

tests/backend/test_senior_tier_visibility.py::test_senior_progress_api
  D:\EvalForge\tests\backend\test_senior_tier_visibility.py:86: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    completed_at=datetime.utcnow()

tests/backend/test_senior_tier_visibility.py::test_senior_progress_api
tests/backend/test_senior_tier_visibility.py::test_senior_boss_runs_api
  D:\EvalForge\arcade_app\models.py:252: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expires_at: datetime = Field(default_factory=lambda: datetime.utcnow() + timedelta(minutes=30))

tests/backend/test_senior_tier_visibility.py::test_senior_progress_api
  D:\EvalForge\arcade_app\practice\service_senior.py:127: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    updated_at=datetime.utcnow(),

tests/backend/test_senior_tier_visibility.py::test_senior_boss_runs_api
  D:\EvalForge\tests\backend\test_senior_tier_visibility.py:139: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    completed_at=datetime.utcnow()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/backend/test_senior_tier_visibility.py::test_senior_progress_api
FAILED tests/backend/test_senior_tier_visibility.py::test_senior_boss_runs_api
======================= 2 failed, 18 warnings in 1.48s ========================
