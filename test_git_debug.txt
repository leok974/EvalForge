============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0
rootdir: D:\EvalForge
plugins: anyio-4.11.0, Faker-37.11.0, langsmith-0.4.38, asyncio-1.2.0, cov-7.0.0, env-1.2.0, httpx-0.35.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1 item

tests\backend\test_boss_timeline_history_smoke.py 
DEBUG RESPONSE DATA KEYS: ['label', 'results', 'overall_pass']
DEBUG RESPONSE DATA: {'label': 'worlds-fundamentals', 'results': [{'boss_slug': 'boss-timeline-history-rewriter', 'rubric_id': 'boss-timeline-history-rewriter', 'score': 8, 'grade': 'S', 'min_score_required': 6, 'passed': True, 'boss_hp_before': 100, 'boss_hp_after': 100, 'boss_hp_delta': -100, 'integrity_before': 100, 'integrity_after': 100, 'integrity_delta': 0, 'criteria': [{'id': 'graph_literacy_and_diagnosis', 'score': 2, 'feedback': 'Perfect implementation'}, {'id': 'recovery_and_rescue_skills', 'score': 2, 'feedback': 'Perfect implementation'}, {'id': 'history_safety_and_collaboration', 'score': 2, 'feedback': 'Perfect implementation'}, {'id': 'runbook_clarity_and_copy_paste_safety', 'score': 2, 'feedback': 'Perfect implementation'}]}], 'overall_pass': True}
F

================================== FAILURES ===================================
___________________ test_timeline_history_boss_judge_smoke ____________________

client = <httpx.AsyncClient object at 0x0000022895D46A50>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x0000022895CB6C40>
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x0000022895DD1A90>

    @pytest.mark.asyncio
    async def test_timeline_history_boss_judge_smoke(client, monkeypatch, db_session):
        """
        Smoke test: ensure History Rewriter boss QA returns a valid BossEvalResult.
        """
    
        # SEED BOSS DEFINITION (Ensures it exists in the test DB)
        boss = BossDefinition(
            id="boss-timeline-history-rewriter",
            name="History Rewriter",
            description="The Timeline boss",
            rubric="boss-timeline-history-rewriter",
            base_xp_reward=500,
            max_hp=100,
            difficulty="hard",
            enabled=True
        )
        db_session.add(boss)
        await db_session.commit()
    
        # Enable Mock Grading Mode to bypass Vertex AI auth/mocks issues
        monkeypatch.setenv("EVALFORGE_MOCK_GRADING", "1")
    
        payload = {
            "world_slug": "world-git",
            "boss_id": "boss-timeline-history-rewriter",
            "mode": "smoke",
            "submission_markdown": """# Git Incident Runbook û Smoke Test
    
    # MAGIC_BOSS_PASS
    
    ## Incident Context
    History mangled on feature/auth-redesign after a bad rebase/force-push. Bug surfaced post-deploy.
    
    ## Phase 1 û Inspect & Map the Graph
    - git fetch --all --prune
    - git log --oneline --graph --decorate --all
    - git branch -vv to see divergence.
    
    ## Phase 2 û Recovery Plan
    - Use git reflog on feature/auth-redesign to find pre-rebase tip.
    - Create backup/auth-redesign-pre-rebase branch at that reflog entry.
    - Compare old vs new feature history to find lost commits.
    
    ## Phase 3 û Execute Safely
    - Use git bisect between known good tag and main head to find culprit.
    - On main, prefer git revert on bad commit rather than rewriting public history.
    - Push main + cherry-pick to release/1.2 as needed.
    
    ## Phase 4 û Verify & Communicate
    - Verify tests and staging after revert.
    - Add branch protection for main/release.
    - Document incident and updated Git guidelines.
    """
        }
    
        # Use the test client to hit the endpoint
        # Note: 'client' fixture comes from pytest-asyncio + httpx usually
        resp = await client.post("/api/dev/boss_qa/worlds", json=payload)
        assert resp.status_code == 200, f"Response: {resp.text}"
    
        data = resp.json()
        print(f"\nDEBUG RESPONSE DATA KEYS: {list(data.keys())}")
        print(f"DEBUG RESPONSE DATA: {data}")
    
>       assert data["boss_slug"] == "boss-timeline-history-rewriter"
               ^^^^^^^^^^^^^^^^^
E       KeyError: 'boss_slug'

tests\backend\test_boss_timeline_history_smoke.py:70: KeyError
============================== warnings summary ===============================
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

arcade_app\agent.py:440
  D:\EvalForge\arcade_app\agent.py:440: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\applications.py:4523
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\applications.py:4523: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

tests/backend/test_boss_timeline_history_smoke.py::test_timeline_history_boss_judge_smoke
tests/backend/test_boss_timeline_history_smoke.py::test_timeline_history_boss_judge_smoke
tests/backend/test_boss_timeline_history_smoke.py::test_timeline_history_boss_judge_smoke
tests/backend/test_boss_timeline_history_smoke.py::test_timeline_history_boss_judge_smoke
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\fields.py:656: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return fac()

tests/backend/test_boss_timeline_history_smoke.py::test_timeline_history_boss_judge_smoke
  D:\EvalForge\arcade_app\models.py:252: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expires_at: datetime = Field(default_factory=lambda: datetime.utcnow() + timedelta(minutes=30))

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/backend/test_boss_timeline_history_smoke.py::test_timeline_history_boss_judge_smoke
======================== 1 failed, 8 warnings in 0.81s ========================
