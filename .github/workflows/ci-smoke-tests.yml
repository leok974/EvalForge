name: CI Smoke Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  guardrail-tests:
    name: Guardrail Tests - Model Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run guardrail test for model defaults
        run: |
          python tests/test_env_model.py
      
      - name: Verify model version in code
        run: |
          # Ensure code defaults to gemini-2.5-flash
          grep -q "gemini-2\.5-flash" arcade_app/agent.py || \
            (echo "ERROR: Model default not set to gemini-2.5-flash" && exit 1)
          echo "✓ Model default verified in code"

  smoke-evalforge:
    name: EvalForge Inference Smoke Tests
    runs-on: windows-latest
    needs: guardrail-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set environment variables
        run: |
          echo "VERTEX_PROJECT_NUMBER=291179078777" >> $env:GITHUB_ENV
          echo "VERTEX_REGION=us-central1" >> $env:GITHUB_ENV
          echo "VERTEX_MODEL_ID=gemini-2.5-flash" >> $env:GITHUB_ENV
      
      - name: Start local server
        run: |
          cd arcade_app
          Start-Process -NoNewWindow -FilePath "python" -ArgumentList "-m","google.adk.cli","web",".","--port","19000","--host","0.0.0.0"
          Start-Sleep -Seconds 10
      
      - name: Wait for server to be ready
        run: |
          $retries = 0
          $maxRetries = 30
          while ($retries -lt $maxRetries) {
            try {
              $response = Invoke-WebRequest -Uri "http://127.0.0.1:19000/list-apps?relative_path=arcade_app" -TimeoutSec 2 -UseBasicParsing
              if ($response.StatusCode -eq 200) {
                Write-Host "✓ Server is ready"
                exit 0
              }
            } catch {
              Write-Host "Waiting for server... ($retries/$maxRetries)"
              Start-Sleep -Seconds 2
              $retries++
            }
          }
          Write-Host "❌ Server failed to start"
          exit 1
      
      - name: Run endpoint smoke tests
        run: |
          pwsh scripts/smoke.ps1 -Env local
      
      - name: Run model inference smoke tests
        run: |
          pwsh scripts/smoke_model.ps1 -Base http://127.0.0.1:19000
      
      - name: Stop server
        if: always()
        run: |
          Get-Process | Where-Object {$_.ProcessName -eq "python"} | Stop-Process -Force

  e2e-smoke:
    name: E2E Smoke Tests (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: guardrail-tests
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Node.js dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Set environment variables (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "EVALFORGE_EVENT_LOG=0" >> $GITHUB_ENV
          echo "GOOGLE_GENAI_USE_VERTEXAI=FALSE" >> $GITHUB_ENV
          echo "VERTEX_PROJECT_NUMBER=291179078777" >> $GITHUB_ENV
          echo "VERTEX_REGION=us-central1" >> $GITHUB_ENV
          echo "VERTEX_MODEL_ID=gemini-2.5-flash" >> $GITHUB_ENV
      
      - name: Set environment variables (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "EVALFORGE_EVENT_LOG=0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "GOOGLE_GENAI_USE_VERTEXAI=FALSE" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "VERTEX_PROJECT_NUMBER=291179078777" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "VERTEX_REGION=us-central1" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          echo "VERTEX_MODEL_ID=gemini-2.5-flash" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      
      - name: Start dev server (Linux)
        if: runner.os == 'Linux'
        run: |
          python -m uvicorn arcade_app.agent:app --host 127.0.0.1 --port 19000 &
          sleep 5
      
      - name: Start dev server (Windows)
        if: runner.os == 'Windows'
        run: |
          Start-Process -NoNewWindow -FilePath "python" -ArgumentList "-m","uvicorn","arcade_app.agent:app","--host","127.0.0.1","--port","19000"
          Start-Sleep -Seconds 5
      
      - name: Wait for server readiness
        run: |
          node -e "
          const http = require('http');
          let retries = 30;
          const check = () => {
            http.get('http://127.0.0.1:19000/', (res) => {
              if (res.statusCode === 200) {
                console.log('✓ Server ready');
                process.exit(0);
              } else {
                if (--retries > 0) setTimeout(check, 1000);
                else { console.error('❌ Server timeout'); process.exit(1); }
              }
            }).on('error', () => {
              if (--retries > 0) setTimeout(check, 1000);
              else { console.error('❌ Server timeout'); process.exit(1); }
            });
          };
          check();
          "
      
      - name: Run Playwright smoke tests
        env:
          BASE_URL: http://127.0.0.1:19000
        run: npm run test:smoke
      
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.os }}
          path: playwright-report/
          retention-days: 7
      
      - name: Stop server (Linux)
        if: always() && runner.os == 'Linux'
        run: |
          pkill -f "uvicorn arcade_app.agent:app" || true
      
      - name: Stop server (Windows)
        if: always() && runner.os == 'Windows'
        run: |
          Get-Process | Where-Object {$_.CommandLine -like "*uvicorn*arcade_app*"} | Stop-Process -Force -ErrorAction SilentlyContinue

  cloud-run-smoke-tests:
    name: Cloud Run Smoke Tests
    runs-on: ubuntu-latest
    needs: guardrail-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Get Cloud Run service URL
        id: get-url
        run: |
          BASE=$(gcloud run services describe evalforge-agents \
            --region us-central1 \
            --format='value(status.url)')
          echo "BASE_URL=$BASE" >> $GITHUB_OUTPUT
      
      - name: Verify environment variables in Cloud Run
        run: |
          # Check that gemini-2.5-flash is configured
          gcloud run services describe evalforge-agents \
            --region us-central1 \
            --format="value(spec.template.spec.containers[0].env)" | \
            grep -q "gemini-2\.5-flash" || \
            (echo "ERROR: Model version not set to gemini-2.5-flash in Cloud Run" && exit 1)
          echo "✓ Cloud Run environment variable verified"
      
      - name: Test list-apps endpoint
        env:
          BASE_URL: ${{ steps.get-url.outputs.BASE_URL }}
        run: |
          curl -sf "$BASE_URL/list-apps?relative_path=arcade_app" > /dev/null || \
            (echo "ERROR: list-apps endpoint failed" && exit 1)
          echo "✓ list-apps endpoint passed"
      
      - name: Test session creation
        env:
          BASE_URL: ${{ steps.get-url.outputs.BASE_URL }}
        run: |
          curl -sf -X POST -H "Content-Length: 0" \
            "$BASE_URL/apps/arcade_app/users/user/sessions" > /dev/null || \
            (echo "ERROR: session creation failed" && exit 1)
          echo "✓ session creation passed"
      
      - name: Verify model version in deployment
        run: |
          gcloud run services describe evalforge-agents \
            --region us-central1 \
            --format="value(spec.template.spec.containers[0].env)" | \
            grep "gemini-2\.5-flash" || \
            (echo "ERROR: Model version verification failed" && exit 1)
          echo "✓ Model version verification passed"
      
      - name: Check for Vertex AI errors in logs
        run: |
          # Check recent logs for 404/403 errors
          ERRORS=$(gcloud logging read \
            'resource.type="cloud_run_revision" 
             AND resource.labels.service_name="evalforge-agents" 
             AND (textPayload:"404 NOT_FOUND" OR textPayload:"403 PERMISSION_DENIED")
             AND timestamp>="'$(date -u -d '5 minutes ago' --iso-8601=seconds)'"' \
            --limit=10 \
            --format='value(textPayload)' 2>/dev/null || echo "")
          
          if [ ! -z "$ERRORS" ]; then
            echo "WARNING: Found Vertex AI errors in logs:"
            echo "$ERRORS"
            exit 1
          fi
          echo "✓ No Vertex AI errors in recent logs"

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [guardrail-tests, e2e-smoke, cloud-run-smoke-tests]
    if: always()
    
    steps:
      - name: Check test results
        run: |
          echo "Guardrail Tests: ${{ needs.guardrail-tests.result }}"
          echo "E2E Smoke Tests: ${{ needs.e2e-smoke.result }}"
          echo "Cloud Run Tests: ${{ needs.cloud-run-smoke-tests.result }}"
          
          if [ "${{ needs.guardrail-tests.result }}" != "success" ]; then
            echo "❌ Guardrail tests failed"
            exit 1
          fi
          
          if [ "${{ needs.e2e-smoke.result }}" == "failure" ]; then
            echo "❌ E2E smoke tests failed"
            exit 1
          fi
          
          if [ "${{ needs.cloud-run-smoke-tests.result }}" == "failure" ]; then
            echo "❌ Cloud Run smoke tests failed"
            exit 1
          fi
          
          echo "✅ All tests passed"
