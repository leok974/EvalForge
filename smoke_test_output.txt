============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0 -- C:\Python313\python.exe
cachedir: .pytest_cache
rootdir: D:\EvalForge
plugins: anyio-4.11.0, Faker-37.11.0, langsmith-0.4.38, asyncio-1.2.0, cov-7.0.0, env-1.2.0, httpx-0.35.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/backend/test_boss_archives_query_smoke.py::test_archives_query_boss_judge_smoke 
DEBUG Payload: {'world_slug': 'world-sql', 'boss_id': 'boss-archives-query-warden', 'mode': 'smoke', 'submission_markdown': '# Analytics Query Incident Runbook û Smoke Test\n\n# MAGIC_BOSS_PASS\n\n## Incident Context\nDAU and revenue by country are inflated/missing after a query change; performance is worse.\n\n## Phase 1 û Clarify the Metric\n- Define DAU as COUNT(DISTINCT user_id) per day + country (UTC).\n- Revenue as SUM(amount) per day + country.\n\n## Phase 2 û Inspect Current Query & Data\n- Save current SQL and look for risky joins and filters.\n- Sample events and orders to understand distributions.\n\n## Phase 3 û Propose Corrected Query\n- Separate daily_dau and daily_revenue aggregates.\n- Join them at day + country grain via countries dim.\n- Use LEFT JOIN to keep countries visible even with 0 activity.\n\n## Phase 4 û Performance & Safety Checks\n- Run EXPLAIN/EXPLAIN ANALYZE to inspect plan.\n- Ensure predicates on event_ts/created_at can use indexes/partitions.\n- Add appropriate indexes on date + country_code if missing.\n\n## Phase 5 û Rollout & Monitoring\n- Compare old vs new metrics for a few countries/days.\n- Backfill to a sandbox table, wire dashboards via feature flag.\n- Monitor latency and metric shapes after deploy.\n'}
2025-12-07 14:04:27,091 INFO sqlalchemy.engine.Engine select pg_catalog.version()
2025-12-07 14:04:27,091 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-07 14:04:27,093 INFO sqlalchemy.engine.Engine select current_schema()
2025-12-07 14:04:27,094 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-07 14:04:27,095 INFO sqlalchemy.engine.Engine show standard_conforming_strings
2025-12-07 14:04:27,095 INFO sqlalchemy.engine.Engine [raw sql] ()
2025-12-07 14:04:27,096 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-07 14:04:27,114 INFO sqlalchemy.engine.Engine SELECT "user".id AS user_id, "user".name AS user_name, "user".avatar_url AS user_avatar_url, "user".current_avatar_id AS user_current_avatar_id, "user".created_at AS user_created_at 
FROM "user" 
WHERE "user".id = $1::VARCHAR
2025-12-07 14:04:27,114 INFO sqlalchemy.engine.Engine [generated in 0.00020s] ('leo',)
2025-12-07 14:04:27,124 INFO sqlalchemy.engine.Engine ROLLBACK
2025-12-07 14:04:27,145 INFO sqlalchemy.engine.Engine BEGIN (implicit)
2025-12-07 14:04:27,146 INFO sqlalchemy.engine.Engine SELECT profile.id, profile.user_id, profile.total_xp, profile.global_level, profile.skill_points, profile.world_progress, profile.flags 
FROM profile 
WHERE profile.user_id = $1::VARCHAR
2025-12-07 14:04:27,146 INFO sqlalchemy.engine.Engine [generated in 0.00013s] ('leo',)
2025-12-07 14:04:27,150 INFO sqlalchemy.engine.Engine SELECT bossdefinition.id, bossdefinition.name, bossdefinition.description, bossdefinition.rubric, bossdefinition.starting_code, bossdefinition.world_id, bossdefinition.track_id, bossdefinition.project_slug, bossdefinition.tech_focus, bossdefinition.phase, bossdefinition.time_limit_seconds, bossdefinition.max_hp, bossdefinition.base_xp_reward, bossdefinition.difficulty, bossdefinition.hint_codex_id, bossdefinition.enabled, bossdefinition.created_at, bossdefinition.updated_at 
FROM bossdefinition 
WHERE bossdefinition.id = $1::VARCHAR
2025-12-07 14:04:27,150 INFO sqlalchemy.engine.Engine [generated in 0.00018s] ('boss-archives-query-warden',)
2025-12-07 14:04:27,153 INFO sqlalchemy.engine.Engine INSERT INTO bossrun (user_id, boss_id, started_at, expires_at, completed_at, result, score, hp_remaining, judge_trace_id, notes) VALUES ($1::VARCHAR, $2::VARCHAR, $3::TIMESTAMP WITHOUT TIME ZONE, $4::TIMESTAMP WITHOUT TIME ZONE, $5::TIMESTAMP WITHOUT TIME ZONE, $6::VARCHAR, $7::INTEGER, $8::INTEGER, $9::VARCHAR, $10::VARCHAR) RETURNING bossrun.id
2025-12-07 14:04:27,153 INFO sqlalchemy.engine.Engine [generated in 0.00018s] ('leo', 'boss-archives-query-warden', datetime.datetime(2025, 12, 7, 19, 4, 27, 152611), datetime.datetime(2025, 12, 7, 19, 34, 27, 152632), None, None, 0, 0, None, None)
2025-12-07 14:04:27,157 INFO sqlalchemy.engine.Engine ROLLBACK
FAILED

================================== FAILURES ===================================
____________________ test_archives_query_boss_judge_smoke _____________________

client = <httpx.AsyncClient object at 0x000001810E972A50>
vertex_text = <function vertex_text.<locals>._setter at 0x000001810E9C8400>

    @pytest.mark.asyncio
    async def test_archives_query_boss_judge_smoke(client, vertex_text):
        """
        Smoke test: ensure Archive Query Warden boss QA returns a valid BossEvalResult.
        """
    
        payload = {
            "world_slug": "world-sql",
            "boss_id": "boss-archives-query-warden",
            "mode": "smoke",
            "submission_markdown": """# Analytics Query Incident Runbook û Smoke Test
    
    # MAGIC_BOSS_PASS
    
    ## Incident Context
    DAU and revenue by country are inflated/missing after a query change; performance is worse.
    
    ## Phase 1 û Clarify the Metric
    - Define DAU as COUNT(DISTINCT user_id) per day + country (UTC).
    - Revenue as SUM(amount) per day + country.
    
    ## Phase 2 û Inspect Current Query & Data
    - Save current SQL and look for risky joins and filters.
    - Sample events and orders to understand distributions.
    
    ## Phase 3 û Propose Corrected Query
    - Separate daily_dau and daily_revenue aggregates.
    - Join them at day + country grain via countries dim.
    - Use LEFT JOIN to keep countries visible even with 0 activity.
    
    ## Phase 4 û Performance & Safety Checks
    - Run EXPLAIN/EXPLAIN ANALYZE to inspect plan.
    - Ensure predicates on event_ts/created_at can use indexes/partitions.
    - Add appropriate indexes on date + country_code if missing.
    
    ## Phase 5 û Rollout & Monitoring
    - Compare old vs new metrics for a few countries/days.
    - Backfill to a sandbox table, wire dashboards via feature flag.
    - Monitor latency and metric shapes after deploy.
    """
        }
    
        # Debug print payload
        print(f"\nDEBUG Payload: {payload}")
    
>       resp = await client.post("/api/dev/boss_qa/worlds", json=payload)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\backend\test_boss_archives_query_smoke.py:48: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\httpx\_client.py:1859: in post
    return await self.request(
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\httpx\_client.py:1540: in request
    return await self.send(request, auth=auth, follow_redirects=follow_redirects)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\httpx\_client.py:1629: in send
    response = await self._send_handling_auth(
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\httpx\_client.py:1657: in _send_handling_auth
    response = await self._send_handling_redirects(
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\httpx\_client.py:1694: in _send_handling_redirects
    response = await self._send_single_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\httpx\_client.py:1730: in _send_single_request
    response = await transport.handle_async_request(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\httpx\_transports\asgi.py:170: in handle_async_request
    await self.app(scope, receive, send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\applications.py:1082: in __call__
    await super().__call__(scope, receive, send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\applications.py:113: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\middleware\errors.py:186: in __call__
    raise exc
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\middleware\errors.py:164: in __call__
    await self.app(scope, receive, _send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\middleware\cors.py:85: in __call__
    await self.app(scope, receive, send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\middleware\exceptions.py:63: in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\routing.py:716: in __call__
    await self.middleware_stack(scope, receive, send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\routing.py:736: in app
    await route.handle(scope, receive, send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\routing.py:290: in handle
    await self.app(scope, receive, send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\routing.py:78: in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\_exception_handler.py:53: in wrapped_app
    raise exc
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\_exception_handler.py:42: in wrapped_app
    await app(scope, receive, sender)
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\starlette\routing.py:75: in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\routing.py:308: in app
    raw_response = await run_endpoint_function(
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\routing.py:219: in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
arcade_app\routers\routes_boss_qa_worlds.py:60: in run_world_boss_qa_route
    raise e
arcade_app\routers\routes_boss_qa_worlds.py:56: in run_world_boss_qa_route
    report = await run_standard_world_boss_qa(db=session, player=profile, min_scores=min_scores, request=request)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
arcade_app\boss_qa_worlds.py:239: in run_standard_world_boss_qa
    status = await _run_single_boss_world_qa(
arcade_app\boss_qa_worlds.py:61: in _run_single_boss_world_qa
    eval_result: BossEvalResult = await judge_boss_with_rubric(
arcade_app\grading_helper.py:205: in judge_boss_with_rubric
    rubric = load_boss_rubric(rubric_id)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

rubric_id = 'boss-archives-query-warden'

    def load_boss_rubric(rubric_id: str) -> BossRubric:
        """
        Load a boss rubric JSON by rubric_id.
    
        Args:
            rubric_id: The rubric identifier (e.g., 'applylens_runtime_boss')
    
        Returns:
            Parsed BossRubric object
    
        Raises:
            FileNotFoundError: If rubric file doesn't exist
        """
        # Support both direct filename and rubric_id format
        if rubric_id.endswith('.json'):
            path = RUBRIC_DIR / rubric_id
        else:
            # Try boss-{slug} format first (our actual naming)
            slug_format = rubric_id.replace('_', '-')
            path = RUBRIC_DIR / f"boss-{slug_format}.json"
    
            if not path.exists():
                # Fallback to direct rubric_id.json
                path = RUBRIC_DIR / f"{rubric_id}.json"
    
        with path.open("r", encoding="utf-8") as f:
            data = json.load(f)
    
>       rubric = BossRubric.model_validate(data)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       pydantic_core._pydantic_core.ValidationError: 12 validation errors for BossRubric
E       dimensions.0.bands
E         Field required [type=missing, input_value={'key': 'requirement_tran...oin types behavior).'}]}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       dimensions.1.bands
E         Field required [type=missing, input_value={'key': 'query_correctnes...erve dimension rows.'}]}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       dimensions.2.bands
E         Field required [type=missing, input_value={'key': 'performance_and_... performance safely.'}]}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       dimensions.3.bands
E         Field required [type=missing, input_value={'key': 'runbook_clarity_...ns for safe rollout.'}]}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       grade_bands.0.min_score
E         Field required [type=missing, input_value={'floor': 8, 'grade': 'S'...l': "Warden's Favorite"}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       grade_bands.0.description
E         Field required [type=missing, input_value={'floor': 8, 'grade': 'S'...l': "Warden's Favorite"}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       grade_bands.1.min_score
E         Field required [type=missing, input_value={'floor': 6, 'grade': 'A'...l': 'Certified Analyst'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       grade_bands.1.description
E         Field required [type=missing, input_value={'floor': 6, 'grade': 'A'...l': 'Certified Analyst'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       grade_bands.2.min_score
E         Field required [type=missing, input_value={'floor': 4, 'grade': 'B', 'label': 'Query Tyro'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       grade_bands.2.description
E         Field required [type=missing, input_value={'floor': 4, 'grade': 'B', 'label': 'Query Tyro'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       grade_bands.3.min_score
E         Field required [type=missing, input_value={'floor': 0, 'grade': 'C'...el': 'Full-Scan Victim'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing
E       grade_bands.3.description
E         Field required [type=missing, input_value={'floor': 0, 'grade': 'C'...el': 'Full-Scan Victim'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.11/v/missing

arcade_app\boss_rubric_helper.py:52: ValidationError
------------------------------ Captured log call ------------------------------
INFO     sqlalchemy.engine.Engine:base.py:1846 select pg_catalog.version()
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:1846 select current_schema()
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:1846 show standard_conforming_strings
INFO     sqlalchemy.engine.Engine:base.py:1846 [raw sql] ()
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT "user".id AS user_id, "user".name AS user_name, "user".avatar_url AS user_avatar_url, "user".current_avatar_id AS user_current_avatar_id, "user".created_at AS user_created_at 
FROM "user" 
WHERE "user".id = $1::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00020s] ('leo',)
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
INFO     sqlalchemy.engine.Engine:base.py:2702 BEGIN (implicit)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT profile.id, profile.user_id, profile.total_xp, profile.global_level, profile.skill_points, profile.world_progress, profile.flags 
FROM profile 
WHERE profile.user_id = $1::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00013s] ('leo',)
INFO     sqlalchemy.engine.Engine:base.py:1846 SELECT bossdefinition.id, bossdefinition.name, bossdefinition.description, bossdefinition.rubric, bossdefinition.starting_code, bossdefinition.world_id, bossdefinition.track_id, bossdefinition.project_slug, bossdefinition.tech_focus, bossdefinition.phase, bossdefinition.time_limit_seconds, bossdefinition.max_hp, bossdefinition.base_xp_reward, bossdefinition.difficulty, bossdefinition.hint_codex_id, bossdefinition.enabled, bossdefinition.created_at, bossdefinition.updated_at 
FROM bossdefinition 
WHERE bossdefinition.id = $1::VARCHAR
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00018s] ('boss-archives-query-warden',)
INFO     sqlalchemy.engine.Engine:base.py:1846 INSERT INTO bossrun (user_id, boss_id, started_at, expires_at, completed_at, result, score, hp_remaining, judge_trace_id, notes) VALUES ($1::VARCHAR, $2::VARCHAR, $3::TIMESTAMP WITHOUT TIME ZONE, $4::TIMESTAMP WITHOUT TIME ZONE, $5::TIMESTAMP WITHOUT TIME ZONE, $6::VARCHAR, $7::INTEGER, $8::INTEGER, $9::VARCHAR, $10::VARCHAR) RETURNING bossrun.id
INFO     sqlalchemy.engine.Engine:base.py:1846 [generated in 0.00018s] ('leo', 'boss-archives-query-warden', datetime.datetime(2025, 12, 7, 19, 4, 27, 152611), datetime.datetime(2025, 12, 7, 19, 34, 27, 152632), None, None, 0, 0, None, None)
INFO     sqlalchemy.engine.Engine:base.py:2705 ROLLBACK
============================== warnings summary ===============================
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

arcade_app\agent.py:440
  D:\EvalForge\arcade_app\agent.py:440: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\applications.py:4523
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\applications.py:4523: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

tests/backend/test_boss_archives_query_smoke.py::test_archives_query_boss_judge_smoke
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\fields.py:656: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return fac()

tests/backend/test_boss_archives_query_smoke.py::test_archives_query_boss_judge_smoke
  D:\EvalForge\arcade_app\models.py:252: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    expires_at: datetime = Field(default_factory=lambda: datetime.utcnow() + timedelta(minutes=30))

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/backend/test_boss_archives_query_smoke.py::test_archives_query_boss_judge_smoke
======================== 1 failed, 5 warnings in 0.37s ========================
