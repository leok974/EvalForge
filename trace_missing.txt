============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-8.4.2, pluggy-1.6.0
rootdir: D:\EvalForge
plugins: anyio-4.11.0, Faker-37.11.0, langsmith-0.4.38, asyncio-1.2.0, cov-7.0.0, env-1.2.0, httpx-0.35.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 1 item

tests\backend\test_boss_oracle_invocation_smoke.py TEST DEBUG START: If you see this, stdout capturing works.
DEBUG: arcade_app location: D:\EvalForge\arcade_app\__init__.py
DEBUG: Result Grade: MISSING, Score: 0
F

================================== FAILURES ===================================
___________________ test_oracle_invocation_boss_judge_smoke ___________________

client = <httpx.AsyncClient object at 0x000002A127842A50>
patch_tracks_for_judge = None
judge_smoke_session = ('smoke_test_user', 'test_session_123')
db_session = <sqlalchemy.orm.session.AsyncSession object at 0x000002A1278B9BE0>
monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x000002A1277B2C40>

    @pytest.mark.asyncio
    async def test_oracle_invocation_boss_judge_smoke(client, patch_tracks_for_judge, judge_smoke_session, db_session, monkeypatch):
        """
        Smoke test: ensure Oracle Invocation Summoner boss QA path returns a valid BossEvalResult.
        This uses the ZERO boss judge oracle invocation prompt + rubric + golden blueprint.
        """
        print("TEST DEBUG START: If you see this, stdout capturing works.")
        import arcade_app
        print(f"DEBUG: arcade_app location: {arcade_app.__file__}")
    
        # SEED BOSS DEFINITION (Ensures it exists even if ingestion script failed)
        boss = BossDefinition(
            id="boss-oracle-invocation-summoner",
            name="Oracle Invocation Summoner",
            description="Agents world boss",
            rubric="boss-oracle-invocation-summoner",
            base_xp_reward=500,
            max_hp=100,
            difficulty="hard",
            enabled=True
        )
        db_session.merge(boss) # Use merge to update if exists
        await db_session.commit()
    
        # Enable Mock Grading Mode to bypass Vertex AI auth/mocks issues
        monkeypatch.setenv("EVALFORGE_MOCK_GRADING", "1")
    
        # The payload we send. API expects 'submission_markdown' which is passed to judge.
        # We add "MAGIC_BOSS_PASS" to ensure the mock judge awards full score (8/8).
        payload = {
            "world_slug": "world-agents",
            "boss_id": "boss-oracle-invocation-summoner",
            "mode": "smoke",
            "submission_markdown": """# Invocation Blueprint รป Smoke Test
    
    MAGIC_BOSS_PASS
    
    ## Scenario
    Agent helps engineers debug latency and understand code/architecture using repo_search, doc_search, metrics_query.
    
    ## Tools
    - repo_search(query): find code/config snippets.
    - doc_search(query): find runbooks/ADRs.
    - metrics_query(query): fetch latency/error metrics.
    
    ## Orchestrator Flow
    1. Classify question_type and subjects (endpoints/services).
    2. Plan steps: metrics_query -> repo_search -> doc_search (if needed).
    3. Execute tools in order, summarizing each result.
    4. Synthesize answer with evidence and next steps.
    
    ## Guardrails & Grounding
    - Always call metrics_query for system behavior questions.
    - Always call repo_search for code-related questions.
    - Retry tools once on failure, then surface uncertainty.
    
    ## Observability & Debugging
    - Log intent, plan, tool_calls, final_answer_summary as JSON.
    - Metrics: agent_requests_total, agent_tool_calls_total, grounding_rate.
    """
        }
    
        # Send request
        resp = await client.post("/api/dev/boss_qa/worlds", json=payload)
    
        if resp.status_code != 200:
            print(f"Resp: {resp.text}")
    
        assert resp.status_code == 200
    
        data = resp.json()
    
        # The endpoint returns { results: [...], overall_pass: ... }
        assert len(data["results"]) == 1
        res = data["results"][0]
    
        # Basic shape checks รป match BossEvalResult contract
        assert res["boss_slug"] == "boss-oracle-invocation-summoner"
    
        print(f"DEBUG: Result Grade: {res.get('grade')}, Score: {res.get('score')}")
    
        # Mock grader with MAGIC_BOSS_PASS should return max score (8)
>       assert res["score"] == 8
E       assert 0 == 8

tests\backend\test_boss_oracle_invocation_smoke.py:86: AssertionError
============================== warnings summary ===============================
C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\_internal\_config.py:323: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

arcade_app\agent.py:440
  D:\EvalForge\arcade_app\agent.py:440: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    @app.on_event("startup")

C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\applications.py:4523
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\fastapi\applications.py:4523: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).
          
    return self.router.on_event(event_type)

tests/backend/test_boss_oracle_invocation_smoke.py::test_oracle_invocation_boss_judge_smoke
tests/backend/test_boss_oracle_invocation_smoke.py::test_oracle_invocation_boss_judge_smoke
tests/backend/test_boss_oracle_invocation_smoke.py::test_oracle_invocation_boss_judge_smoke
  C:\Users\pierr\AppData\Roaming\Python\Python313\site-packages\pydantic\fields.py:656: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    return fac()

tests/backend/test_boss_oracle_invocation_smoke.py::test_oracle_invocation_boss_judge_smoke
  D:\EvalForge\tests\backend\test_boss_oracle_invocation_smoke.py:25: RuntimeWarning: coroutine 'AsyncSession.merge' was never awaited
    db_session.merge(boss) # Use merge to update if exists
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/backend/test_boss_oracle_invocation_smoke.py::test_oracle_invocation_boss_judge_smoke
======================== 1 failed, 7 warnings in 0.81s ========================
